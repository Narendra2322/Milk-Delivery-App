<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Orders - Shift White Gold</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{height:100%;margin:0;font-family:Arial,sans-serif;background:#f7f7f7}
    .header{display:flex;justify-content:space-between;align-items:center;padding:14px 24px;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,0.04);position:sticky;top:0;z-index:1000}
    .logo{font-weight:800;color:#2b652e;font-size:1.15em}
    .btn{background:#2b652e;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-block}
    .container{max-width:1200px;margin:20px auto;padding:0 20px}
    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
    .order-card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.06);margin-bottom:20px;transition:transform 0.2s,box-shadow 0.2s}
    .order-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.1)}
    .order-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid #f0f0f0}
    .order-id{font-size:1.2rem;font-weight:800;color:#2b652e}
    .order-date{color:#999;font-size:0.85rem;margin-top:4px}
    .status-badge{padding:6px 12px;border-radius:6px;font-size:0.85rem;font-weight:700;display:inline-block}
    .status-placed{background:#ffc107;color:#000}
    .status-accepted{background:#4caf50;color:#fff}
    .status-out_for_delivery{background:#2196f3;color:#fff}
    .status-delivered{background:#4caf50;color:#fff}
    .order-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px}
    .detail-item{background:#f8f9fa;padding:12px;border-radius:8px}
    .detail-label{color:#666;font-size:0.85rem;margin-bottom:4px}
    .detail-value{color:#222;font-weight:700;font-size:1.05rem}
    .order-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
    .btn-track{background:#ff9f1c;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:700;text-decoration:none;display:inline-block;transition:background 0.3s}
    .btn-track:hover{background:#e68a00}
    .btn-reorder{background:#2b652e;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:700;transition:background 0.3s}
    .btn-reorder:hover{background:#3a8540}
    .no-orders{text-align:center;padding:80px 20px;background:#fff;border-radius:12px;margin-top:40px}
    .no-orders-icon{font-size:4rem;margin-bottom:20px;opacity:0.5}
    .filter-tabs{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
    .filter-tab{background:#fff;border:2px solid #e0e0e0;color:#666;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s}
    .filter-tab.active{background:#2b652e;color:#fff;border-color:#2b652e}
    .filter-tab:hover{border-color:#2b652e}
    @media(max-width:768px){.order-details{grid-template-columns:1fr}.order-actions{flex-direction:column}}
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">ðŸ¥› Shift White Gold</div>
    <div style="display:flex;gap:10px">
      <a href="index.html" class="btn" style="background:#eee;color:#222">Home</a>
      <a href="cart.html" class="btn">Cart</a>
      <button id="signOutBtn" class="btn" style="background:#ff4d4f">Sign Out</button>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <div>
        <h1 style="color:#2b652e;margin:0">My Orders</h1>
        <p style="color:#666;margin:8px 0 0 0">Track and manage your milk orders</p>
      </div>
      <div id="orderStats" style="display:flex;gap:16px"></div>
    </div>

    <div class="filter-tabs">
      <button class="filter-tab active" data-filter="all">All Orders</button>
      <button class="filter-tab" data-filter="placed">Pending</button>
      <button class="filter-tab" data-filter="accepted">Confirmed</button>
      <button class="filter-tab" data-filter="out_for_delivery">Out for Delivery</button>
      <button class="filter-tab" data-filter="delivered">Delivered</button>
    </div>

    <div id="ordersList"></div>

    <div id="noOrders" class="no-orders" style="display:none">
      <div class="no-orders-icon">ðŸ“¦</div>
      <h2 style="color:#666;margin:0 0 16px 0">No Orders Yet</h2>
      <p style="color:#999;margin:0 0 24px 0">Start ordering fresh milk from local sellers</p>
      <a href="index.html" class="btn">Browse Sellers</a>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:4000/api';
    let allOrders = [];
    let currentFilter = 'all';

    function getCurrent(){ return JSON.parse(localStorage.getItem('currentUser')||'null'); }
    function getToken(){ const cur = getCurrent(); return cur && cur.token ? cur.token : null; }

    async function loadOrders(){
      const current = getCurrent();
      if(!current){
        window.location.href = 'login.html?redirect=orders.html';
        return [];
      }

      const token = getToken();
      
      // Try server first
      if(token){
        try{
          const res = await fetch(API_BASE + '/orders', { headers: { 'Authorization': 'Bearer ' + token }});
          if(res.ok){
            const orders = await res.json();
            return orders;
          }
        }catch(e){}
      }

      // Fallback to localStorage
      const localOrders = JSON.parse(localStorage.getItem('orders')||'[]');
      return localOrders.filter(o => o.buyerPhone === current.phone || o.buyerId === current._id);
    }

    async function loadSeller(sellerId){
      try{
        const res = await fetch(API_BASE + '/sellers');
        if(res.ok){
          const sellers = await res.json();
          return sellers.find(s => s._id === sellerId);
        }
      }catch(e){}
      const users = JSON.parse(localStorage.getItem('users')||'[]');
      return users.find(u => u._id === sellerId && u.role === 'seller');
    }

    function getStatusText(status){
      if(!status || status === 'placed') return 'Pending';
      if(status === 'accepted') return 'Confirmed';
      if(status === 'out_for_delivery') return 'Out for Delivery';
      if(status === 'delivered') return 'Delivered';
      return status;
    }

    function getStatusClass(status){
      if(!status || status === 'placed') return 'status-placed';
      if(status === 'accepted') return 'status-accepted';
      if(status === 'out_for_delivery') return 'status-out_for_delivery';
      if(status === 'delivered') return 'status-delivered';
      return 'status-placed';
    }

    async function renderOrders(filter = 'all'){
      currentFilter = filter;
      const ordersList = document.getElementById('ordersList');
      const noOrders = document.getElementById('noOrders');
      
      ordersList.innerHTML = '<div style="text-align:center;padding:40px;color:#999">Loading orders...</div>';

      allOrders = await loadOrders();
      
      // Remove duplicates
      allOrders = Array.from(new Map(allOrders.map(o => [o.id, o])).values());
      
      // Sort by date (newest first)
      allOrders.sort((a, b) => new Date(b.time) - new Date(a.time));

      // Filter orders
      let filteredOrders = allOrders;
      if(filter !== 'all'){
        filteredOrders = allOrders.filter(o => (o.status || 'placed') === filter);
      }

      if(filteredOrders.length === 0){
        ordersList.innerHTML = '';
        noOrders.style.display = 'block';
        return;
      }

      noOrders.style.display = 'none';
      ordersList.innerHTML = '';

      // Render stats
      renderStats();

      // Render each order
      for(const order of filteredOrders){
        const seller = await loadSeller(order.sellerId);
        const card = document.createElement('div');
        card.className = 'order-card';
        
        const status = order.status || 'placed';
        const statusText = getStatusText(status);
        const statusClass = getStatusClass(status);
        
        card.innerHTML = `
          <div class="order-header">
            <div>
              <div class="order-id">Order #${String(order.id).substring(0,12)}</div>
              <div class="order-date">${new Date(order.time).toLocaleString()}</div>
            </div>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
          
          <div class="order-details">
            <div class="detail-item">
              <div class="detail-label">Seller</div>
              <div class="detail-value">${seller ? `${seller.fname} ${seller.lname}` : 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Quantity</div>
              <div class="detail-value">${order.liters}L</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Total Amount</div>
              <div class="detail-value">â‚¹${order.total}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Payment</div>
              <div class="detail-value">Cash on Delivery</div>
            </div>
          </div>
          
          <div class="order-actions">
            <a href="tracking.html?orderId=${order.id}" class="btn-track">ðŸ“¦ Track Order</a>
            ${status === 'delivered' ? `<button class="btn-reorder" data-seller="${order.sellerId}" data-liters="${order.liters}">ðŸ”„ Reorder</button>` : ''}
          </div>
        `;
        
        ordersList.appendChild(card);
        
        // Attach reorder handler
        if(status === 'delivered'){
          const reorderBtn = card.querySelector('.btn-reorder');
          if(reorderBtn){
            reorderBtn.addEventListener('click', ()=>{
              const cart = JSON.parse(localStorage.getItem('cart')||'[]');
              cart.push({
                sellerId: order.sellerId,
                sellerName: seller ? `${seller.fname} ${seller.lname}` : 'Seller',
                milkCost: seller ? seller.milkCost : 0,
                liters: order.liters
              });
              localStorage.setItem('cart', JSON.stringify(cart));
              alert('âœ“ Added to cart!');
              window.location.href = 'cart.html';
            });
          }
        }
      }
    }

    function renderStats(){
      const stats = document.getElementById('orderStats');
      const pending = allOrders.filter(o => (o.status || 'placed') === 'placed').length;
      const active = allOrders.filter(o => ['accepted','out_for_delivery'].includes(o.status || 'placed')).length;
      const delivered = allOrders.filter(o => (o.status || 'placed') === 'delivered').length;
      
      stats.innerHTML = `
        <div style="text-align:center;background:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
          <div style="color:#ffc107;font-size:1.5rem;font-weight:800">${pending}</div>
          <div style="color:#666;font-size:0.85rem">Pending</div>
        </div>
        <div style="text-align:center;background:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
          <div style="color:#2196f3;font-size:1.5rem;font-weight:800">${active}</div>
          <div style="color:#666;font-size:0.85rem">Active</div>
        </div>
        <div style="text-align:center;background:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06)">
          <div style="color:#4caf50;font-size:1.5rem;font-weight:800">${delivered}</div>
          <div style="color:#666;font-size:0.85rem">Delivered</div>
        </div>
      `;
    }

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', ()=>{
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        renderOrders(tab.dataset.filter);
      });
    });

    // Sign out
    document.getElementById('signOutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('currentUser');
      window.location.href = 'login.html';
    });

    // Auto-refresh every 10 seconds
    setInterval(() => renderOrders(currentFilter), 10000);

    document.addEventListener('DOMContentLoaded', () => renderOrders());
  </script>
</body>
</html>
